<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reset Home</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    --bg: #fafafa;
    --surface: #ffffff;
    --border: #e5e7eb;
    --border-light: #f0f0f0;
    --text: #1f2937;
    --text-dim: #6b7280;
    --text-light: #9ca3af;
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --radius: 8px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  /* HEADER */
  .header {
    padding: 32px 40px 24px;
    max-width: 1800px;
    margin: 0 auto;
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }
  .header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.02em;
  }
  .header-sub {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-top: 2px;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .sync-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.78rem;
    color: var(--text-light);
  }
  .sync-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }
  .sync-dot.connected { background: #22c55e; }
  .sync-dot.disconnected { background: #ef4444; }
  .sync-dot.local { background: #f59e0b; }
  .settings-link {
    font-size: 0.78rem;
    color: var(--text-light);
    cursor: pointer;
    border: none;
    background: none;
    font-family: inherit;
  }
  .settings-link:hover { color: var(--text-dim); }

  /* TABS */
  .tab-bar {
    max-width: 1800px;
    margin: 0 auto;
    padding: 0 40px;
    display: flex;
    gap: 24px;
    border-bottom: 1px solid var(--border);
  }
  .tab {
    padding: 10px 0;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-dim);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    user-select: none;
    transition: color 0.15s;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--text); border-bottom-color: var(--text); }

  /* CONTENT */
  .content {
    padding: 24px 40px;
    max-width: 1800px;
    margin: 0 auto;
  }

  /* TABLE */
  .table-wrapper {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.84rem;
  }
  th {
    padding: 10px 12px;
    text-align: left;
    font-weight: 500;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-light);
    border-bottom: 1px solid var(--border);
  }
  th a {
    color: var(--text-light);
    text-decoration: none;
    font-weight: 500;
  }
  th a:hover { color: var(--accent); text-decoration: underline; }
  td {
    padding: 16px;
    border-bottom: 1px solid var(--border-light);
    vertical-align: top;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #f8f9fb; }

  /* COMMUNITY */
  .prop-name {
    font-weight: 600;
    color: var(--accent);
    text-decoration: none;
    font-size: 0.88rem;
  }
  .prop-name:hover { text-decoration: underline; }
  .prop-sub {
    color: var(--text-dim);
    font-size: 0.78rem;
    margin-top: 1px;
  }
  .floor-plans-link {
    font-size: 0.75rem;
    color: var(--text-light);
    text-decoration: none;
    margin-top: 3px;
    display: inline-block;
  }
  .floor-plans-link:hover { color: var(--accent); }

  /* COST */
  .cost-input {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text);
    background: none;
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 2px 4px;
    font-family: inherit;
    width: 100%;
    min-width: 140px;
  }
  .cost-input:hover { border-color: var(--border); }
  .cost-input:focus {
    outline: none;
    border-color: var(--accent);
    background: var(--bg);
  }
  .cost-special {
    font-size: 0.75rem;
    color: var(--text-dim);
    font-style: italic;
    margin-top: 2px;
  }
  .cost-warning {
    font-size: 0.75rem;
    color: #dc2626;
    font-weight: 500;
    margin-top: 2px;
  }
  .cost-unit {
    font-size: 0.75rem;
    color: var(--accent);
    margin-top: 2px;
    display: inline-block;
  }
  .cost-unit:hover { text-decoration: underline; }
  .tub-no { color: #dc2626; font-weight: 600; font-size: 0.82rem; }
  .tub-yes { color: #16a34a; font-weight: 500; font-size: 0.82rem; }
  .tub-unknown { color: var(--text-light); font-size: 0.82rem; }
  .beach-cell { white-space: nowrap; }
  .beach-cell a { font-size: 0.8rem; }
  .beach-dist { font-size: 0.72rem; color: var(--text-dim); display: block; }
  .group-header {
    text-align: center;
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-dim);
    border-bottom: none;
    padding-bottom: 2px;
  }

  /* WALK SCORE */
  .ws {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .ws-num { font-weight: 600; font-size: 0.88rem; }
  .ws-label { font-size: 0.72rem; color: var(--text-light); }

  /* LOCATION */
  .nearby {
    font-size: 0.78rem;
    color: var(--text-dim);
    line-height: 1.5;
  }

  /* STANDOUT */
  .standout-text {
    font-size: 0.82rem;
    color: var(--text);
    margin-bottom: 6px;
    min-width: 180px;
  }
  .amenities-list {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  /* DISTANCE */
  .dist-stack { font-size: 0.8rem; line-height: 1.6; }
  .dist-label { color: var(--text-light); font-size: 0.72rem; }

  /* NOTES */
  .notes-cell { min-width: 220px; }
  .note-textarea {
    width: 100%;
    min-height: 60px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 10px;
    font-size: 0.8rem;
    font-family: inherit;
    resize: vertical;
    line-height: 1.4;
  }
  .note-textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
  }

  /* ACTIONS */
  .actions-cell {
    white-space: nowrap;
    text-align: center;
  }
  .act-wrap {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    margin: 0 2px;
  }
  .act-label {
    font-size: 0.62rem;
    color: var(--text-light);
    margin-top: 1px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .act-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    padding: 4px 6px;
    border-radius: 4px;
    transition: all 0.15s;
    vertical-align: middle;
  }
  .act-love {
    color: #9ca3af;
  }
  .act-love:hover {
    color: #e11d48;
  }
  .act-love.loved {
    color: #e11d48;
  }
  .act-pass {
    color: #9ca3af;
    font-size: 0.85rem;
  }
  .act-pass:hover {
    color: #6b7280;
  }
  .btn-restore {
    font-size: 0.78rem;
    color: var(--accent);
    cursor: pointer;
    border: none;
    background: none;
    font-family: inherit;
    padding: 4px 0;
  }
  .btn-restore:hover { text-decoration: underline; }
  .declined-info {
    font-size: 0.72rem;
    color: var(--text-light);
    margin-top: 4px;
  }

  /* LINKS */
  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* MAP */
  .map-section { margin-top: 40px; }
  .map-section h2 {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text);
  }
  #map {
    height: 400px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    z-index: 1;
  }

  /* MODAL */
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.3);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
  }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    max-width: 460px;
    width: 90%;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  }
  .modal h2 { font-size: 1rem; font-weight: 600; margin-bottom: 12px; }
  .modal p { color: var(--text-dim); font-size: 0.85rem; margin-bottom: 14px; line-height: 1.5; }
  .modal input {
    width: 100%;
    padding: 8px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 0.85rem;
    margin-bottom: 14px;
    font-family: inherit;
  }
  .modal input:focus { outline: none; border-color: var(--accent); }
  .modal-buttons { display: flex; gap: 8px; justify-content: flex-end; }
  .modal-btn {
    padding: 6px 16px;
    border-radius: 6px;
    font-size: 0.82rem;
    font-family: inherit;
    cursor: pointer;
    font-weight: 500;
  }
  .modal-btn-cancel {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
  }
  .modal-btn-cancel:hover { background: var(--bg); }
  .modal-btn-save {
    background: var(--accent);
    border: 1px solid var(--accent);
    color: #fff;
  }
  .modal-btn-save:hover { background: var(--accent-hover); }

  /* ADD ROW */
  .add-row td {
    padding: 12px 16px;
    border-top: 1px dashed var(--border);
    border-bottom: none;
    background: none;
  }
  .add-row:hover td { background: none; }
  .add-input {
    width: 100%;
    padding: 6px 8px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.82rem;
    font-family: inherit;
    color: var(--text);
  }
  .add-input:focus {
    outline: none;
    border-color: var(--accent);
  }
  .add-input::placeholder { color: var(--text-light); }
  .add-btn {
    padding: 5px 14px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 0.78rem;
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
  }
  .add-btn:hover { background: var(--accent-hover); }
  .add-btn:disabled {
    background: var(--border);
    cursor: default;
  }
  .add-section-header td {
    background: var(--text);
    color: #fff;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 8px 16px;
    border-bottom: none;
  }
  .add-section-header:hover td { background: var(--text); }
  .delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-light);
    font-size: 0.75rem;
    font-family: inherit;
    padding: 2px 0;
  }
  .delete-btn:hover { color: #dc2626; }

  /* EMPTY STATE */
  .empty-row {
    text-align: center;
    padding: 48px 16px;
    color: var(--text-light);
    font-size: 0.85rem;
  }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .header { padding: 20px 16px 16px; }
    .content { padding: 16px; }
    .tab-bar { padding: 0 16px; }
    td, th { padding: 10px 8px; font-size: 0.78rem; }
  }
</style>
</head>
<body>

<div id="app"></div>

<script>
// ==================== DATA ====================
const DEFAULT_PROPERTIES = [
  {
    id: "icon-las-olas",
    name: "Icon",
    neighborhood: "Las Olas",
    address: "500 E Las Olas Blvd, Fort Lauderdale, FL 33301",
    lat: 26.1186, lng: -80.1337,
    cost: "$5,732/mo",
    costMin: 5732,
    walkScore: 94,
    soakingTub: "yes",
    walkableTo: ["Galleria Mall"],
    amenities: ["Sky lounge", "Spa", "Resort pool", "Valet"],
    standout: "42-story tower. Sky lounge & spa.",
    nearestBeach: { label: "Las Olas Beach", dist: "2.4 mi", url: "https://www.google.com/maps/dir/500+E+Las+Olas+Blvd,+Fort+Lauderdale,+FL+33301/Las+Olas+Beach,+240+Las+Olas+Cir,+Fort+Lauderdale,+FL+33304/@26.1191445,-80.1315304,15z/data=!3m1!4b1!4m14!4m13!1m5!1m1!1s0x88d9005728d00539:0x7459626d06b4e582!2m2!1d-80.1378433!2d26.1187293!1m5!1m1!1s0x88d9002ea8ac8e39:0xef53c86186347d87!2m2!1d-80.104211!2d26.1191999!3e2?entry=ttu" },
    distHeron: { miles: 17, mins: 25 }, distMiami: { miles: 30, mins: 35 },
    distWM: { miles: 3, mins: 10 }, distLasOlas: { miles: 0, mins: 1, walkMins: 1 },
    distBirch: { miles: 2, mins: 6 }, distAIDS: { miles: 3, mins: 10 },
    link: "https://iconlasolasfl.com/luxury-apartment-amenities/",
    special: "2 mo free if lease within 24hrs of tour",
    notes: "",
    proposedUnit: { label: "2BR/2.5BA+den — available now", url: "https://iconlasolasfl.com/floorplans/2x2-5denl/?unit_name=905" },
    warning: "",
    nixed: false, nixedBy: '', nixedAt: '',
    ferrellLoved: false, nikiLoved: false
  },
  {
    id: "flow-ftl",
    name: "Flow",
    neighborhood: "Downtown FTL",
    address: "221 SW 1st Ave, Fort Lauderdale, FL 33301",
    lat: 26.1186, lng: -80.1437,
    cost: "$3,632/mo (+ furn. fee)",
    costMin: 3632,
    walkScore: 91,
    soakingTub: "no",
    walkableTo: ["Brightline", "NSU Art Museum"],
    amenities: ["Private restaurant", "Co-working", "Screening room"],
    standout: "Private restaurant & co-working. Furnished units.",
    nearestBeach: { label: "Las Olas Beach", dist: "2.8 mi", url: "https://www.google.com/maps/dir/Flow+Hotel+Fort+Lauderdale,+221+SW+1st+Ave,+Fort+Lauderdale,+FL+33301/Las+Olas+Beach,+240+Las+Olas+Cir,+Fort+Lauderdale,+FL+33304/@26.1197626,-80.1348417,15z/data=!3m1!4b1!4m14!4m13!1m5!1m1!1s0x88d9014d45387941:0x29d8a540582c9ea3!2m2!1d-80.1448301!2d26.118972!1m5!1m1!1s0x88d9002ea8ac8e39:0xef53c86186347d87!2m2!1d-80.104211!2d26.1191999!3e2?entry=ttu" },
    distHeron: { miles: 17, mins: 25 }, distMiami: { miles: 30, mins: 35 },
    distWM: { miles: 3, mins: 10 }, distLasOlas: { miles: 0.5, mins: 3, walkMins: 10 },
    distBirch: { miles: 3, mins: 10 }, distAIDS: { miles: 3, mins: 10 },
    link: "https://flow.life/en/properties/fort-lauderdale/flow-life?active=1",
    special: "Up to 2 mo free on select units",
    notes: "",
    proposedUnit: { label: "Sebastian Inlet 2BR furnished", url: "https://flow.life/en/properties/fort-lauderdale/available-homes/sebastian-inlet-2-bedroom-furnished/fid/4c38e13212899004d0?beds=2&moveInDate=2026-03-01" },
    warning: "",
    nixed: false, nixedBy: '', nixedAt: '',
    ferrellLoved: false, nikiLoved: false
  },
  {
    id: "1757-ne-9th",
    name: "Townhouse",
    neighborhood: "Victoria Park",
    address: "1757 NE 9th St, Fort Lauderdale, FL 33304",
    lat: 26.1345, lng: -80.1253,
    cost: "$5,800/mo",
    costMin: 5800,
    walkScore: 72,
    soakingTub: "yes",
    walkableTo: ["Victoria Park trails"],
    amenities: ["2-car garage", "Impact windows", "10ft ceilings"],
    standout: "Standalone 3BR house with garage. Scenic walking area.",
    nearestBeach: { label: "Birch Beach", dist: "1.4 mi", url: "https://www.google.com/maps/dir/1757+NE+9th+St,+Fort+Lauderdale,+FL+33304/26.1379611,-80.1027289/@26.1408973,-80.1052074,17.07z/data=!4m9!4m8!1m5!1m1!1s0x88d901b7aa5fbb47:0xd930d7ecac2431b1!2m2!1d-80.1232189!2d26.1357632!1m0!3e2?entry=ttu" },
    distHeron: { miles: 15, mins: 22 }, distMiami: { miles: 30, mins: 35 },
    distWM: { miles: 2, mins: 7 }, distLasOlas: { miles: 1.2, mins: 5, walkMins: 25 },
    distBirch: { miles: 1.5, mins: 5, walkMins: 25 }, distAIDS: { miles: 2, mins: 7 },
    link: "https://www.zillow.com/homedetails/1757-NE-9th-St-Fort-Lauderdale-FL-33304/246619186_zpid/",
    special: "",
    notes: "",
    proposedUnit: null,
    warning: "",
    nixed: false, nixedBy: '', nixedAt: '',
    ferrellLoved: false, nikiLoved: false
  },
  {
    id: "wilton-metro",
    name: "Metropolitan",
    neighborhood: "Wilton Manors",
    address: "1220 NE 24th St, Wilton Manors, FL 33305",
    lat: 26.1548, lng: -80.1365,
    cost: "$2,500 – $3,700",
    costMin: 2500,
    walkScore: 76,
    soakingTub: "yes",
    walkableTo: ["World AIDS Museum", "Colohatchee Park"],
    amenities: ["Tennis", "Yoga", "Massage", "Dog park"],
    standout: "Best value. Full resort amenities on Wilton Drive.",
    nearestBeach: { label: "Birch Beach", dist: "3.2 mi", url: "https://www.google.com/maps/dir/Metropolitan,+1220+NE+24th+St,+Wilton+Manors,+FL+33305/26.1379611,-80.1027289/@26.1486819,-80.1282276,15z/data=!3m1!4b1!4m9!4m8!1m5!1m1!1s0x88d90190a5c355b5:0xbb662c0c8a754fee!2m2!1d-80.1305767!2d26.1574102!1m0!3e2?entry=ttu" },
    distHeron: { miles: 12, mins: 20 }, distMiami: { miles: 33, mins: 40 },
    distWM: { miles: 0.3, mins: 2, walkMins: 6 }, distLasOlas: { miles: 3, mins: 10 },
    distBirch: { miles: 2.5, mins: 8 }, distAIDS: { miles: 0.3, mins: 2, walkMins: 6 },
    link: "https://www.wiltonmetro.com/#section-metropolitan-living",
    special: "2 mo free on select units",
    notes: "",
    proposedUnit: null,
    warning: "No unit until 4/15",
    nixed: false, nixedBy: '', nixedAt: '',
    ferrellLoved: false, nikiLoved: false
  },
  {
    id: "novo-las-olas",
    name: "Novo",
    neighborhood: "Las Olas",
    address: "220 SE 2nd St, Fort Lauderdale, FL 33301",
    lat: 26.1176, lng: -80.1387,
    cost: "$3,479 – $4,987",
    costMin: 3479,
    walkScore: 94,
    soakingTub: "yes",
    walkableTo: ["Discovery Museum"],
    amenities: ["Resort pool", "Fitness center"],
    standout: "On-site GreenWise Market. Grocery convenience.",
    nearestBeach: { label: "FTL Beach", dist: "2.5 mi", url: "https://www.google.com/maps/dir/?api=1&origin=220+SE+2nd+St,+Fort+Lauderdale,+FL&destination=Fort+Lauderdale+Beach,+FL&travelmode=walking" },
    distHeron: { miles: 17, mins: 25 }, distMiami: { miles: 30, mins: 35 },
    distWM: { miles: 3, mins: 10 }, distLasOlas: { miles: 0.3, mins: 2, walkMins: 6 },
    distBirch: { miles: 2.5, mins: 8 }, distAIDS: { miles: 3, mins: 10 },
    link: "https://www.novolasolas.com/",
    special: "1 mo free if move in by 6/30",
    notes: "",
    proposedUnit: null,
    warning: "",
    nixed: false, nixedBy: '', nixedAt: '',
    ferrellLoved: false, nikiLoved: false
  },
  {
    id: "mizner-park",
    name: "Mizner Park",
    neighborhood: "Boca Raton",
    address: "401 NE Mizner Blvd, Boca Raton, FL 33432",
    lat: 26.3467, lng: -80.0834,
    cost: "$3,525 – $5,830",
    costMin: 3525,
    walkScore: 93,
    soakingTub: "",
    walkableTo: ["Mizner Park shops", "Boca beach (~1 mi)"],
    amenities: ["Rooftop pool", "Fitness center", "Pet-friendly"],
    standout: "Upscale dining, shopping, movies & beach within a mile.",
    distHeron: { miles: 22, mins: 30 }, distMiami: { miles: 50, mins: 55 },
    distWM: { miles: 20, mins: 28 }, distLasOlas: { miles: 22, mins: 30 },
    distBirch: { miles: 18, mins: 25 }, distAIDS: { miles: 20, mins: 28 },
    link: "https://www.gables.com/communities/florida/boca-raton/mizner-park-apartments",
    special: "",
    notes: "",
    proposedUnit: null,
    warning: "",
    nixed: false, nixedBy: '', nixedAt: '',
    ferrellLoved: false, nikiLoved: false
  },
  {
    id: "aviah-flagler",
    name: "Aviah",
    neighborhood: "Flagler Village",
    address: "440 NE 4th Ave, Fort Lauderdale, FL 33301",
    lat: 26.1275, lng: -80.1383,
    cost: "$2,390 – $3,516",
    costMin: 2390,
    walkScore: 96,
    soakingTub: "",
    walkableTo: ["Flagler Village arts", "Fat Village"],
    amenities: ["2-story fitness", "Yoga/spinning", "Dog park", "Sky homes"],
    standout: "Walk Score 96. Unique sky-homes with 19ft ceilings.",
    distHeron: { miles: 16, mins: 24 }, distMiami: { miles: 30, mins: 35 },
    distWM: { miles: 2, mins: 7 }, distLasOlas: { miles: 1, mins: 5 },
    distBirch: { miles: 2.5, mins: 8 }, distAIDS: { miles: 2, mins: 7 },
    link: "https://www.liveataviah.com/amenities/",
    special: "1 mo free for eligible applicants",
    notes: "",
    proposedUnit: null,
    warning: "",
    nixed: false, nixedBy: '', nixedAt: '',
    ferrellLoved: false, nikiLoved: false
  }
];

// ==================== APP STATE ====================
const API_KEY = "apartment-finder-v2";
let STATE = {
  properties: [],
  activeTab: "active",
  apiUrl: "https://apartment-finder.nikireidoriginal.workers.dev",
  syncStatus: "local",
  showConfig: false
};

// ==================== STORAGE ====================
function loadState() {
  const saved = localStorage.getItem(API_KEY);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      STATE.properties = parsed.properties || DEFAULT_PROPERTIES;
      STATE.apiUrl = parsed.apiUrl || "https://apartment-finder.nikireidoriginal.workers.dev";
      migrateProperties(STATE.properties);
    } catch(e) {
      STATE.properties = DEFAULT_PROPERTIES.map(p => ({...p}));
    }
  } else {
    STATE.properties = DEFAULT_PROPERTIES.map(p => ({...p}));
  }
}

function migrateProperties(props) {
  const defaultMap = new Map(DEFAULT_PROPERTIES.map(d => [d.id, d]));
  props.forEach(p => {
    if (p.ferrellLoved === undefined) p.ferrellLoved = p.loved || false;
    if (p.nikiLoved === undefined) p.nikiLoved = false;
    if (p.nixedBy === undefined) p.nixedBy = '';
    if (p.nixedAt === undefined) p.nixedAt = '';
    if (p.nearestBeach === undefined) p.nearestBeach = null;
    // Refresh display fields from defaults
    const def = defaultMap.get(p.id);
    if (def) {
      p.name = def.name;
      p.neighborhood = def.neighborhood || '';
      p.soakingTub = def.soakingTub;
      p.standout = def.standout;
      p.amenities = [...def.amenities];
      p.walkableTo = [...def.walkableTo];
      p.special = def.special;
      p.warning = def.warning;
      if (def.nearestBeach) p.nearestBeach = {...def.nearestBeach};
      if (def.proposedUnit) p.proposedUnit = {...def.proposedUnit};
      else p.proposedUnit = null;
    }
  });
}

function saveStateLocal() {
  localStorage.setItem(API_KEY, JSON.stringify({
    properties: STATE.properties,
    apiUrl: STATE.apiUrl
  }));
}

function saveState() {
  saveStateLocal();
  if (STATE.apiUrl) syncToRemote();
}

// ==================== MERGE ====================
function mergeProperty(local, remote) {
  const m = {...local};
  // Preserve loves from either side
  if (remote.ferrellLoved && !local.ferrellLoved) m.ferrellLoved = true;
  if (remote.nikiLoved && !local.nikiLoved) m.nikiLoved = true;
  // Preserve declines from either side
  if (remote.nixed && !local.nixed) {
    m.nixed = true;
    m.nixedBy = remote.nixedBy;
    m.nixedAt = remote.nixedAt;
  }
  // Preserve notes — keep remote notes if local is empty
  if (remote.notes && !local.notes) m.notes = remote.notes;
  // Preserve cost edits — keep remote cost if local matches default
  const defaultProp = DEFAULT_PROPERTIES.find(d => d.id === local.id);
  if (defaultProp && local.cost === defaultProp.cost && remote.cost !== defaultProp.cost) {
    m.cost = remote.cost;
  }
  return m;
}

function mergeProperties(local, remote) {
  const remoteMap = new Map(remote.map(p => [p.id, p]));
  const localMap = new Map(local.map(p => [p.id, p]));
  const merged = [];

  // Merge properties that exist in local
  for (const lp of local) {
    if (remoteMap.has(lp.id)) {
      merged.push(mergeProperty(lp, remoteMap.get(lp.id)));
    } else {
      merged.push({...lp});
    }
  }

  // Add remote-only properties (added by the other person)
  for (const rp of remote) {
    if (!localMap.has(rp.id)) {
      merged.push({...rp});
    }
  }

  return merged;
}

// ==================== SYNC ====================
async function syncToRemote() {
  try {
    STATE.syncStatus = "syncing";
    render();

    // Fetch current remote state and merge before pushing
    let remote = [];
    try {
      const getRes = await fetch(STATE.apiUrl + "/api/properties");
      if (getRes.ok) {
        const data = await getRes.json();
        if (Array.isArray(data) && data.length) remote = data;
      }
    } catch(e) {}

    const toSave = remote.length ? mergeProperties(STATE.properties, remote) : STATE.properties;
    STATE.properties = toSave;
    saveStateLocal();

    const res = await fetch(STATE.apiUrl + "/api/properties", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(toSave)
    });
    STATE.syncStatus = res.ok ? "connected" : "error";
  } catch(e) {
    STATE.syncStatus = "error";
  }
  render();
}

async function syncFromRemote() {
  if (!STATE.apiUrl) return;
  try {
    const res = await fetch(STATE.apiUrl + "/api/properties");
    if (res.ok) {
      const data = await res.json();
      if (data && data.length) {
        migrateProperties(data);
        // Merge remote into local instead of overwriting
        STATE.properties = mergeProperties(STATE.properties, data);
        STATE.syncStatus = "connected";
        saveStateLocal();
        render();
      }
    }
  } catch(e) {
    STATE.syncStatus = "local";
  }
}

// ==================== ACTIONS ====================
function declineProperty(id, who) {
  const prop = STATE.properties.find(p => p.id === id);
  if (prop) {
    prop.nixed = true;
    prop.nixedBy = who;
    prop.nixedAt = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    saveState(); render(); renderMap();
  }
}

function restoreProperty(id) {
  const prop = STATE.properties.find(p => p.id === id);
  if (prop) { prop.nixed = false; prop.nixedBy = ''; prop.nixedAt = ''; saveState(); render(); renderMap(); }
}

function toggleLove(id, who) {
  const prop = STATE.properties.find(p => p.id === id);
  if (!prop) return;
  if (who === 'ferrell') prop.ferrellLoved = !prop.ferrellLoved;
  else prop.nikiLoved = !prop.nikiLoved;
  saveState(); render();
}

function updateCost(id, cost) {
  const prop = STATE.properties.find(p => p.id === id);
  if (prop) { prop.cost = cost; saveState(); }
}

function updateNotes(id, notes) {
  const prop = STATE.properties.find(p => p.id === id);
  if (prop) { prop.notes = notes; saveState(); }
}

function deleteProperty(id) {
  STATE.properties = STATE.properties.filter(p => p.id !== id);
  saveState(); render(); renderMap();
}

function addProperty() {
  const name = document.getElementById('add-name').value.trim();
  if (!name) return;
  const cost = document.getElementById('add-cost').value.trim() || '';
  const linkEl = document.getElementById('add-link');
  const link = linkEl ? linkEl.value.trim() : '';
  const notes = document.getElementById('add-notes').value.trim() || '';
  const id = 'custom-' + Date.now();
  STATE.properties.push({
    id, name, neighborhood: '', address: '', lat: 0, lng: 0,
    cost, costMin: 0, walkScore: 0, soakingTub: '',
    walkableTo: [], amenities: [],
    standout: '', distHeron: { miles: 0, mins: 0 }, distMiami: { miles: 0, mins: 0 },
    distWM: { miles: 0, mins: 0 }, distLasOlas: { miles: 0, mins: 0 }, distBirch: { miles: 0, mins: 0 }, distAIDS: { miles: 0, mins: 0 },
    link, special: '', notes, proposedUnit: null, nearestBeach: null, warning: '', nixed: false, nixedBy: '', nixedAt: '', ferrellLoved: false, nikiLoved: false
  });
  saveState();
  render();
  renderMap();
}

// ==================== RENDER ====================
function wsLabel(score) {
  if (score >= 90) return "Walker's Paradise";
  if (score >= 70) return 'Very Walkable';
  if (score >= 50) return 'Somewhat Walkable';
  return 'Car-Dependent';
}

function wsColor(score) {
  if (score >= 90) return '#16a34a';
  if (score >= 70) return '#65a30d';
  if (score >= 50) return '#ca8a04';
  return '#dc2626';
}

function driveRange(mins) {
  const lo = Math.max(5, mins - 5);
  const hi = mins + 5;
  return lo + '–' + hi;
}

function renderWalkDrive(dist) {
  if (!dist || !dist.mins) return '—';
  if (dist.walkMins) return `<span style="color:#16a34a">${dist.walkMins} walk</span>`;
  return driveRange(dist.mins);
}

function renderActionCell(p, who, lovedKey, isPassed) {
  if (isPassed) {
    const isThisDeclined = p.nixedBy === who;
    if (isThisDeclined) {
      return `<button class="btn-restore" onclick="restoreProperty('${p.id}')">Restore</button>
        <div class="declined-info">${p.nixedAt || ''}</div>`;
    }
    return '';
  }
  return `<span class="act-wrap"><button class="act-btn act-love ${p[lovedKey] ? 'loved' : ''}" onclick="toggleLove('${p.id}','${who}')" title="${p[lovedKey] ? 'Remove from favorites' : 'Favorite'}">&#9829;</button><span class="act-label">Love</span></span><span class="act-wrap"><button class="act-btn act-pass" onclick="declineProperty('${p.id}','${who}')" title="Decline">&times;</button><span class="act-label">Decline</span></span>`;
}

function renderTubCell(val) {
  if (val === 'no') return '<span class="tub-no">No</span>';
  if (val === 'yes') return '<span class="tub-yes">Yes</span>';
  return '<span class="tub-unknown">—</span>';
}

function renderPropertyRow(p, isPassed) {
  return `
    <tr>
      <td>
        ${p.link ? `<a class="prop-name" href="${p.link}" target="_blank">${p.name}</a>` : `<span class="prop-name" style="color:var(--text)">${p.name}</span>`}
        ${p.id.startsWith('custom-') ? `<button class="delete-btn" onclick="deleteProperty('${p.id}')">Delete</button>` : ''}
      </td>
      <td style="font-size:0.8rem;color:var(--text-dim)">${p.neighborhood || ''}</td>
      <td>
        <input class="cost-input" type="text" value="${p.cost}"
          onchange="updateCost('${p.id}', this.value)"
          onblur="updateCost('${p.id}', this.value)" />
        ${p.proposedUnit ? `<a class="cost-unit" href="${p.proposedUnit.url}" target="_blank">${p.proposedUnit.label}</a>` : ''}
        ${p.special ? `<div class="cost-special">${p.special}</div>` : ''}
        ${p.warning ? `<div class="cost-warning">${p.warning}</div>` : ''}
      </td>
      <td>
        ${p.walkScore ? `
        <div class="ws">
          <span class="ws-num" style="color:${wsColor(p.walkScore)}">${p.walkScore}</span>
        </div>
        <div class="ws-label">${wsLabel(p.walkScore)}</div>
        ` : '<span style="color:var(--text-light)">—</span>'}
      </td>
      <td>${renderTubCell(p.soakingTub)}</td>
      <td class="beach-cell">
        ${p.nearestBeach ? `<a href="${p.nearestBeach.url}" target="_blank">${p.nearestBeach.label}</a><span class="beach-dist">${p.nearestBeach.dist}</span>` : '<span style="color:var(--text-light)">—</span>'}
      </td>
      <td>
        <div class="nearby">${(p.walkableTo || []).join('<br>')}</div>
      </td>
      <td>
        <div class="standout-text">${p.standout || ''}</div>
        <div class="amenities-list">${(p.amenities || []).join(', ')}</div>
      </td>
      <td>
        <div class="dist-stack">${p.distHeron && p.distHeron.mins ? driveRange(p.distHeron.mins) : '—'}</div>
      </td>
      <td>
        <div class="dist-stack">${p.distMiami && p.distMiami.mins ? driveRange(p.distMiami.mins) : '—'}</div>
      </td>
      <td>
        <div class="dist-stack">${renderWalkDrive(p.distWM)}</div>
      </td>
      <td>
        <div class="dist-stack">${renderWalkDrive(p.distLasOlas)}</div>
      </td>
      <td>
        <div class="dist-stack">${renderWalkDrive(p.distBirch)}</div>
      </td>
      <td>
        <div class="dist-stack">${renderWalkDrive(p.distAIDS)}</div>
      </td>
      <td class="notes-cell">
        <textarea class="note-textarea" placeholder="Add notes..."
          onchange="updateNotes('${p.id}', this.value)"
          onblur="updateNotes('${p.id}', this.value)"
        >${p.notes}</textarea>
      </td>
      <td class="actions-cell">${renderActionCell(p, 'ferrell', 'ferrellLoved', isPassed)}</td>
      <td class="actions-cell">${renderActionCell(p, 'niki', 'nikiLoved', isPassed)}</td>
    </tr>
  `;
}

function render() {
  const active = STATE.properties.filter(p => !p.nixed);
  const defaultOrder = DEFAULT_PROPERTIES.map(d => d.id);
  active.sort((a, b) => {
    const ai = defaultOrder.indexOf(a.id);
    const bi = defaultOrder.indexOf(b.id);
    return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
  });
  const passed = STATE.properties.filter(p => p.nixed);
  const showing = STATE.activeTab === "active" ? active : passed;

  const syncDotClass = STATE.syncStatus === "connected" ? "connected" :
                       STATE.syncStatus === "error" ? "disconnected" : "local";
  const syncLabel = STATE.syncStatus === "connected" ? "Synced" :
                    STATE.syncStatus === "syncing" ? "Syncing..." :
                    STATE.syncStatus === "error" ? "Sync error" : "Local only";

  document.getElementById('app').innerHTML = `
    <div class="header">
      <div>
        <h1>Reset Home</h1>
      </div>
    </div>

    <div class="tab-bar">
      <div class="tab ${STATE.activeTab === 'active' ? 'active' : ''}"
           onclick="STATE.activeTab='active';render()">
        Active (${active.length})
      </div>
      <div class="tab ${STATE.activeTab === 'passed' ? 'active' : ''}"
           onclick="STATE.activeTab='passed';render()">
        Declined (${passed.length})
      </div>
    </div>

    <div class="content">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th rowspan="2">Community</th>
              <th rowspan="2">Area</th>
              <th rowspan="2">Cost / Unit</th>
              <th rowspan="2">Walk<br>Score</th>
              <th rowspan="2">Soaking<br>Tub</th>
              <th rowspan="2"><a href="https://www.google.com/maps/place/Fort+Lauderdale+Beach,+Fort+Lauderdale,+FL" target="_blank">Beach</a></th>
              <th rowspan="2">Nearby</th>
              <th rowspan="2" style="min-width:180px">Standout</th>
              <th colspan="2" class="group-header">Drive Time (min)</th>
              <th colspan="4" class="group-header">Walk / Drive (min)</th>
              <th rowspan="2">Notes</th>
              <th rowspan="2">Ferrell</th>
              <th rowspan="2">Niki</th>
            </tr>
            <tr>
              <th><a href="https://www.google.com/maps/place/Heron+Bay,+Parkland,+FL" target="_blank">Heron Bay</a></th>
              <th><a href="https://www.google.com/maps/place/Miami+Beach,+FL" target="_blank">Miami</a></th>
              <th><a href="https://www.google.com/maps/place/Wilton+Manors,+FL" target="_blank">Wilton Manors</a></th>
              <th><a href="https://www.google.com/maps/place/Las+Olas+Boulevard,+Fort+Lauderdale,+FL" target="_blank">Las Olas</a></th>
              <th><a href="https://www.google.com/maps/place/Hugh+Taylor+Birch+State+Park" target="_blank">Birch Park</a></th>
              <th><a href="https://www.google.com/maps/place/World+AIDS+Museum+and+Educational+Center" target="_blank">AIDS Museum</a></th>
            </tr>
          </thead>
          <tbody>
            ${showing.length === 0
              ? `<tr><td colspan="17" class="empty-row">
                  ${STATE.activeTab === 'active' ? 'No active properties. Restore from the Declined tab.' : 'No declined properties.'}
                 </td></tr>`
              : showing.map(p => renderPropertyRow(p, STATE.activeTab === 'passed')).join('')
            }
            ${STATE.activeTab === 'active' ? `
            <tr class="add-section-header"><td colspan="17">Add to List</td></tr>
            <tr class="add-row">
              <td><input class="add-input" id="add-name" type="text" placeholder="Place name" onkeydown="if(event.key==='Enter')addProperty()" /></td>
              <td></td>
              <td><input class="add-input" id="add-cost" type="text" placeholder="Price" onkeydown="if(event.key==='Enter')addProperty()" /></td>
              <td></td>
              <td></td>
              <td></td>
              <td><input class="add-input" id="add-link" type="text" placeholder="Link (URL)" onkeydown="if(event.key==='Enter')addProperty()" /></td>
              <td colspan="7"></td>
              <td><input class="add-input" id="add-notes" type="text" placeholder="Notes" onkeydown="if(event.key==='Enter')addProperty()" /></td>
              <td colspan="2"><button class="add-btn" onclick="addProperty()">+ Add</button></td>
            </tr>
            ` : ''}
          </tbody>
        </table>
      </div>

      <div class="map-section">
        <h2>Map</h2>
        <div id="map"></div>
      </div>
    </div>

    ${STATE.showConfig ? renderConfigModal() : ''}
  `;

  renderMap();
}

function renderConfigModal() {
  return `
    <div class="modal-overlay" onclick="if(event.target===this){STATE.showConfig=false;render()}">
      <div class="modal">
        <h2>Settings</h2>
        <p>Cloudflare Worker URL for syncing between devices.</p>
        <input id="configApiUrl" type="text" placeholder="https://apartment-finder.your-subdomain.workers.dev" value="${STATE.apiUrl}" />
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="STATE.showConfig=false;render()">Cancel</button>
          <button class="modal-btn modal-btn-save" onclick="STATE.apiUrl=document.getElementById('configApiUrl').value;STATE.showConfig=false;saveState();syncFromRemote();render()">Save</button>
        </div>
      </div>
    </div>
  `;
}

// ==================== MAP ====================
let map = null;
let markers = [];

function renderMap() {
  const mapEl = document.getElementById('map');
  if (!mapEl) return;

  if (map) { map.remove(); map = null; }
  markers = [];

  map = L.map('map', { scrollWheelZoom: true }).setView([26.18, -80.14], 11);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
    maxZoom: 19
  }).addTo(map);

  // Heron Bay marker
  const heronIcon = L.divIcon({
    html: '<div style="background:#6366f1;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.2)"></div>',
    iconSize: [12, 12],
    className: ''
  });
  L.marker([26.19, -80.26], { icon: heronIcon })
    .addTo(map)
    .bindPopup('<b>Heron Bay, Parkland</b><br>Home base');

  // Property markers
  const active = STATE.properties.filter(p => !p.nixed);
  active.forEach(p => {
    const color = '#2563eb';
    const icon = L.divIcon({
      html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.2)"></div>`,
      iconSize: [10, 10],
      className: ''
    });
    const marker = L.marker([p.lat, p.lng], { icon: icon })
      .addTo(map)
      .bindPopup(`
        <b>${p.name}</b><br>
        <span style="font-weight:600">${p.cost}</span><br>
        ~${p.distHeron.mins} min to Heron Bay<br>
        <a href="${p.link}" target="_blank">View property</a>
      `);
    markers.push(marker);
  });

  // Miami Beach marker
  const miamiIcon = L.divIcon({
    html: '<div style="background:#f59e0b;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.2)"></div>',
    iconSize: [12, 12],
    className: ''
  });
  L.marker([25.7907, -80.13], { icon: miamiIcon })
    .addTo(map)
    .bindPopup('<b>Miami Beach</b>');

  // Fit bounds
  const allPoints = [[26.19, -80.26], [25.7907, -80.13], ...active.map(p => [p.lat, p.lng])];
  if (allPoints.length > 1) {
    map.fitBounds(allPoints, { padding: [40, 40] });
  }
}

// ==================== INIT ====================
(async function init() {
  loadState();
  render(); // render immediately with localStorage data
  await syncFromRemote(); // then merge in remote data
  // Poll for remote changes every 30s
  setInterval(() => {
    if (STATE.apiUrl) syncFromRemote();
  }, 30000);
})();
</script>
</body>
</html>
