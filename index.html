<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reset Home</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    --bg: #fafafa;
    --surface: #ffffff;
    --border: #e5e7eb;
    --border-light: #f0f0f0;
    --text: #1f2937;
    --text-dim: #6b7280;
    --text-light: #9ca3af;
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --radius: 8px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  /* HEADER */
  .header {
    padding: 32px 40px 24px;
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }
  .header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.02em;
  }
  .header-sub {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-top: 2px;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .sync-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.78rem;
    color: var(--text-light);
  }
  .sync-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }
  .sync-dot.connected { background: #22c55e; }
  .sync-dot.disconnected { background: #ef4444; }
  .sync-dot.local { background: #f59e0b; }
  .settings-link {
    font-size: 0.78rem;
    color: var(--text-light);
    cursor: pointer;
    border: none;
    background: none;
    font-family: inherit;
  }
  .settings-link:hover { color: var(--text-dim); }

  /* TABS */
  .tab-bar {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 40px;
    display: flex;
    gap: 24px;
    border-bottom: 1px solid var(--border);
  }
  .tab {
    padding: 10px 0;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-dim);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    user-select: none;
    transition: color 0.15s;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--text); border-bottom-color: var(--text); }

  /* CONTENT */
  .content {
    padding: 24px 40px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* TABLE */
  .table-wrapper {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.84rem;
  }
  th {
    padding: 10px 16px;
    text-align: left;
    font-weight: 500;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-light);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  td {
    padding: 16px;
    border-bottom: 1px solid var(--border-light);
    vertical-align: top;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #f8f9fb; }

  /* COMMUNITY */
  .prop-name {
    font-weight: 600;
    color: var(--accent);
    text-decoration: none;
    font-size: 0.88rem;
  }
  .prop-name:hover { text-decoration: underline; }
  .prop-sub {
    color: var(--text-dim);
    font-size: 0.78rem;
    margin-top: 1px;
  }
  .floor-plans-link {
    font-size: 0.75rem;
    color: var(--text-light);
    text-decoration: none;
    margin-top: 3px;
    display: inline-block;
  }
  .floor-plans-link:hover { color: var(--accent); }

  /* COST */
  .cost-input {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text);
    background: none;
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 2px 4px;
    font-family: inherit;
    width: 100%;
    min-width: 140px;
  }
  .cost-input:hover { border-color: var(--border); }
  .cost-input:focus {
    outline: none;
    border-color: var(--accent);
    background: var(--bg);
  }
  .cost-special {
    font-size: 0.75rem;
    color: var(--text-dim);
    font-style: italic;
    margin-top: 2px;
  }

  /* WALK SCORE */
  .ws {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .ws-num { font-weight: 600; font-size: 0.88rem; }
  .ws-label { font-size: 0.72rem; color: var(--text-light); }

  /* LOCATION */
  .nearby {
    font-size: 0.78rem;
    color: var(--text-dim);
    line-height: 1.5;
  }

  /* STANDOUT */
  .standout-text {
    font-size: 0.82rem;
    color: var(--text);
    margin-bottom: 6px;
  }
  .amenities-list {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  /* DISTANCE */
  .dist-stack { font-size: 0.8rem; line-height: 1.6; }
  .dist-label { color: var(--text-light); font-size: 0.72rem; }

  /* NOTES */
  .notes-cell { min-width: 220px; }
  .note-textarea {
    width: 100%;
    min-height: 120px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 10px;
    font-size: 0.8rem;
    font-family: inherit;
    resize: vertical;
    line-height: 1.4;
  }
  .note-textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
  }

  /* ACTIONS */
  .actions-cell {
    white-space: nowrap;
    text-align: center;
  }
  .act-wrap {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    margin: 0 2px;
  }
  .act-label {
    font-size: 0.62rem;
    color: var(--text-light);
    margin-top: 1px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .act-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    padding: 4px 6px;
    border-radius: 4px;
    transition: all 0.15s;
    vertical-align: middle;
  }
  .act-love {
    color: #9ca3af;
  }
  .act-love:hover {
    color: #e11d48;
  }
  .act-love.loved {
    color: #e11d48;
  }
  .act-pass {
    color: #9ca3af;
    font-size: 0.85rem;
  }
  .act-pass:hover {
    color: #6b7280;
  }
  .btn-restore {
    font-size: 0.78rem;
    color: var(--accent);
    cursor: pointer;
    border: none;
    background: none;
    font-family: inherit;
    padding: 4px 0;
  }
  .btn-restore:hover { text-decoration: underline; }
  .declined-info {
    font-size: 0.72rem;
    color: var(--text-light);
    margin-top: 4px;
  }

  /* LINKS */
  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* MAP */
  .map-section { margin-top: 40px; }
  .map-section h2 {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text);
  }
  #map {
    height: 400px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    z-index: 1;
  }

  /* MODAL */
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.3);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
  }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    max-width: 460px;
    width: 90%;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  }
  .modal h2 { font-size: 1rem; font-weight: 600; margin-bottom: 12px; }
  .modal p { color: var(--text-dim); font-size: 0.85rem; margin-bottom: 14px; line-height: 1.5; }
  .modal input {
    width: 100%;
    padding: 8px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 0.85rem;
    margin-bottom: 14px;
    font-family: inherit;
  }
  .modal input:focus { outline: none; border-color: var(--accent); }
  .modal-buttons { display: flex; gap: 8px; justify-content: flex-end; }
  .modal-btn {
    padding: 6px 16px;
    border-radius: 6px;
    font-size: 0.82rem;
    font-family: inherit;
    cursor: pointer;
    font-weight: 500;
  }
  .modal-btn-cancel {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
  }
  .modal-btn-cancel:hover { background: var(--bg); }
  .modal-btn-save {
    background: var(--accent);
    border: 1px solid var(--accent);
    color: #fff;
  }
  .modal-btn-save:hover { background: var(--accent-hover); }

  /* ADD ROW */
  .add-row td {
    padding: 12px 16px;
    border-top: 1px dashed var(--border);
    border-bottom: none;
    background: none;
  }
  .add-row:hover td { background: none; }
  .add-input {
    width: 100%;
    padding: 6px 8px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.82rem;
    font-family: inherit;
    color: var(--text);
  }
  .add-input:focus {
    outline: none;
    border-color: var(--accent);
  }
  .add-input::placeholder { color: var(--text-light); }
  .add-btn {
    padding: 5px 14px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 0.78rem;
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
  }
  .add-btn:hover { background: var(--accent-hover); }
  .add-btn:disabled {
    background: var(--border);
    cursor: default;
  }
  .add-section-header td {
    background: var(--text);
    color: #fff;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 8px 16px;
    border-bottom: none;
  }
  .add-section-header:hover td { background: var(--text); }
  .delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-light);
    font-size: 0.75rem;
    font-family: inherit;
    padding: 2px 0;
  }
  .delete-btn:hover { color: #dc2626; }

  /* EMPTY STATE */
  .empty-row {
    text-align: center;
    padding: 48px 16px;
    color: var(--text-light);
    font-size: 0.85rem;
  }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .header { padding: 20px 16px 16px; }
    .content { padding: 16px; }
    .tab-bar { padding: 0 16px; }
    td, th { padding: 10px 8px; font-size: 0.78rem; }
  }
</style>
</head>
<body>

<div id="app"></div>

<script>
// ==================== DATA ====================
const DEFAULT_PROPERTIES = [
  {
    id: "mizner-park",
    name: "Gables Mizner Park",
    city: "Boca Raton",
    address: "401 NE Mizner Blvd, Boca Raton, FL 33432",
    lat: 26.3467,
    lng: -80.0834,
    cost: "$3,525 – $5,830",
    costMin: 3525,
    walkScore: 93,
    walkableTo: ["Mizner Park shops & dining", "Royal Palm Place", "Boca Raton beach (~1 mi)", "Palmetto Park Rd restaurants"],
    amenities: ["Rooftop pool", "Fitness center", "Pet-friendly", "Covered parking", "Mizner Park lifestyle"],
    standout: "Right in Mizner Park — walkable upscale dining, shopping, movies, and beach within a mile",
    distHeron: { miles: 22, mins: 30 },
    distMiami: { miles: 50, mins: 55 },
    link: "https://www.gables.com/communities/florida/boca-raton/mizner-park-apartments",
    layoutLink: "https://www.gables.com/communities/florida/boca-raton/mizner-park-apartments",
    special: "",
    notes: "",
    nixed: false,
    nixedBy: '',
    nixedAt: '',
    ferrellLoved: false,
    nikiLoved: false
  },
  {
    id: "flow-ftl",
    name: "Flow Fort Lauderdale",
    city: "Fort Lauderdale (Downtown)",
    address: "221 SW 1st Ave, Fort Lauderdale, FL 33301",
    lat: 26.1186,
    lng: -80.1437,
    cost: "$2,892 – $5,475",
    costMin: 2892,
    walkScore: 91,
    walkableTo: ["Las Olas Blvd", "Riverwalk", "NSU Art Museum", "Brightline station", "Downtown restaurants & bars"],
    amenities: ["24/7 fitness center", "Co-working spaces", "Private restaurant", "Pool & sundeck", "Screening room", "34-story tower"],
    standout: "WeWork founder's luxury brand — private restaurant, co-working, stunning views from 34 stories",
    distHeron: { miles: 17, mins: 25 },
    distMiami: { miles: 30, mins: 35 },
    link: "https://flow.life/en/properties/fort-lauderdale/flow-life?active=1",
    layoutLink: "https://flow.life/en/properties/fort-lauderdale/available-homes/sebastian-inlet-2-bedroom-furnished/fid/4c38e13212899004d0?beds=2&moveInDate=2026-03-01",
    special: "Up to 2 mo free on select units",
    notes: "Open to this — but NO units have soaking tubs. Proposed unit: Sebastian Inlet 2BR furnished",
    nixed: false,
    nixedBy: '',
    nixedAt: '',
    ferrellLoved: false,
    nikiLoved: false
  },
  {
    id: "aviah-flagler",
    name: "Aviah Flagler Village",
    city: "Fort Lauderdale (Flagler Village)",
    address: "440 NE 4th Ave, Fort Lauderdale, FL 33301",
    lat: 26.1275,
    lng: -80.1383,
    cost: "$2,390 – $3,516",
    costMin: 2390,
    walkScore: 96,
    walkableTo: ["Flagler Village arts district", "Fat Village", "Downtown FTL", "Las Olas Blvd", "Victoria Park"],
    amenities: ["Resort-style pool & jacuzzi", "2-story 24hr fitness", "Yoga/spinning studio", "Dog park", "Outdoor fireplace & BBQ", "Courtyard homes & sky homes"],
    standout: "Walk Score 96 — best walkability on the list. Unique sky-homes with 19ft ceilings",
    distHeron: { miles: 16, mins: 24 },
    distMiami: { miles: 30, mins: 35 },
    link: "https://www.liveataviah.com/amenities/",
    layoutLink: "https://www.liveataviah.com/plans/",
    special: "1 mo free for eligible applicants",
    notes: "",
    nixed: false,
    nixedBy: '',
    nixedAt: '',
    ferrellLoved: false,
    nikiLoved: false
  },
  {
    id: "novo-las-olas",
    name: "Novo Las Olas",
    city: "Fort Lauderdale (Downtown)",
    address: "220 SE 2nd St, Fort Lauderdale, FL 33301",
    lat: 26.1176,
    lng: -80.1387,
    cost: "$3,479 – $4,987",
    costMin: 3479,
    walkScore: 94,
    walkableTo: ["Las Olas Blvd", "Riverwalk Fort Lauderdale", "Museum of Discovery & Science", "GreenWise Market on-site"],
    amenities: ["Resort-style pool", "State-of-the-art fitness", "On-site GreenWise Market", "3D virtual tours", "Matterport walkthroughs"],
    standout: "On-site GreenWise Market for groceries & ready-made meals — unique convenience factor",
    distHeron: { miles: 17, mins: 25 },
    distMiami: { miles: 30, mins: 35 },
    link: "https://www.novolasolas.com/",
    layoutLink: "https://www.novolasolas.com/Floor-plans.aspx",
    special: "1 mo free if move in by 6/30",
    notes: "",
    nixed: false,
    nixedBy: '',
    nixedAt: '',
    ferrellLoved: false,
    nikiLoved: false
  },
  {
    id: "icon-las-olas",
    name: "Icon Las Olas",
    city: "Fort Lauderdale (Las Olas)",
    address: "500 E Las Olas Blvd, Fort Lauderdale, FL 33301",
    lat: 26.1186,
    lng: -80.1337,
    cost: "$5,732",
    costMin: 5732,
    walkScore: 94,
    walkableTo: ["Las Olas Blvd dining & nightlife", "Fort Lauderdale Beach (~0.8 mi)", "Riverwalk", "Galleria mall area"],
    amenities: ["42-story tower", "Sky lounge", "Resort pool", "Spa", "Fitness center", "Valet parking", "Related Group luxury"],
    standout: "Ultra-luxury 42-story tower by Related Group — closest to the beach on Las Olas. Sky lounge & spa.",
    distHeron: { miles: 17, mins: 25 },
    distMiami: { miles: 30, mins: 35 },
    link: "https://iconlasolasfl.com/luxury-apartment-amenities/",
    layoutLink: "https://iconlasolasfl.com/floorplans/2x2-5denl/?unit_name=905",
    special: "2 mo free if lease within 24hrs of tour",
    notes: "Proposed unit: 2BR/2.5BA+den — $5,732, available now",
    nixed: false,
    nixedBy: '',
    nixedAt: '',
    ferrellLoved: false,
    nikiLoved: false
  },
  {
    id: "wilton-metro",
    name: "Metropolitan (Wilton Metro)",
    city: "Wilton Manors",
    address: "1220 NE 24th St, Wilton Manors, FL 33305",
    lat: 26.1548,
    lng: -80.1365,
    cost: "$2,500 – $3,700",
    costMin: 2500,
    walkScore: 76,
    walkableTo: ["Wilton Drive dining & nightlife", "Five Points", "Colohatchee Park", "Local shops"],
    amenities: ["Pool & hot tub", "Basketball & tennis courts", "Fitness center", "Yoga studio", "Massage room", "Dog park", "Fireplaces"],
    standout: "Best value — full resort amenities with basketball, tennis, yoga, massage. Walkable Wilton Drive nightlife",
    distHeron: { miles: 12, mins: 20 },
    distMiami: { miles: 33, mins: 40 },
    link: "https://www.wiltonmetro.com/#section-metropolitan-living",
    layoutLink: "https://www.wiltonmetro.com/luxury-apartments-wilton-manors/",
    special: "2 mo free on select units",
    notes: "Limited availability — only a 3/2 Veneto model (apt 2115) open, not until 4/15. Probably out.",
    nixed: false,
    nixedBy: '',
    nixedAt: '',
    ferrellLoved: false,
    nikiLoved: false
  },
  {
    id: "1757-ne-9th",
    name: "1757 NE 9th St",
    city: "Fort Lauderdale (Victoria Park)",
    address: "1757 NE 9th St, Fort Lauderdale, FL 33304",
    lat: 26.1345,
    lng: -80.1253,
    cost: "$5,800 (3BR house)",
    costMin: 5800,
    walkScore: 72,
    walkableTo: ["Downtown Wilton Manors", "Las Olas Blvd", "Hugh Taylor Birch State Park", "World AIDS Museum", "Victoria Park walking loops", "Holiday Park"],
    amenities: ["Single-family home", "2-car garage", "Impact windows", "10ft ceilings", "Custom kitchen", "Private balcony", "CBS construction"],
    standout: "Peaceful standalone 3BR house in Victoria Park — walking distance to multiple scenic loops, Taylor Birch Park, Las Olas, and downtown WM. 10ft ceilings, impact windows, 2-car garage.",
    distHeron: { miles: 15, mins: 22 },
    distMiami: { miles: 30, mins: 35 },
    link: "https://www.zillow.com/homedetails/1757-NE-9th-St-Fort-Lauderdale-FL-33304/246619186_zpid/",
    layoutLink: "https://www.zillow.com/homedetails/1757-NE-9th-St-Fort-Lauderdale-FL-33304/246619186_zpid/",
    special: "",
    notes: "",
    nixed: false,
    nixedBy: '',
    nixedAt: '',
    ferrellLoved: false,
    nikiLoved: false
  }
];

// ==================== APP STATE ====================
const API_KEY = "apartment-finder-v2";
let STATE = {
  properties: [],
  activeTab: "active",
  apiUrl: "https://apartment-finder.nikireidoriginal.workers.dev",
  syncStatus: "local",
  showConfig: false
};

// ==================== STORAGE ====================
function loadState() {
  const saved = localStorage.getItem(API_KEY);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      STATE.properties = parsed.properties || DEFAULT_PROPERTIES;
      STATE.apiUrl = parsed.apiUrl || "https://apartment-finder.nikireidoriginal.workers.dev";
      migrateProperties(STATE.properties);
    } catch(e) {
      STATE.properties = DEFAULT_PROPERTIES.map(p => ({...p}));
    }
  } else {
    STATE.properties = DEFAULT_PROPERTIES.map(p => ({...p}));
  }
}

function migrateProperties(props) {
  props.forEach(p => {
    if (p.ferrellLoved === undefined) p.ferrellLoved = p.loved || false;
    if (p.nikiLoved === undefined) p.nikiLoved = false;
    if (p.nixedBy === undefined) p.nixedBy = '';
    if (p.nixedAt === undefined) p.nixedAt = '';
  });
}

function saveStateLocal() {
  localStorage.setItem(API_KEY, JSON.stringify({
    properties: STATE.properties,
    apiUrl: STATE.apiUrl
  }));
}

function saveState() {
  saveStateLocal();
  if (STATE.apiUrl) syncToRemote();
}

// ==================== MERGE ====================
function mergeProperty(local, remote) {
  const m = {...local};
  // Preserve loves from either side
  if (remote.ferrellLoved && !local.ferrellLoved) m.ferrellLoved = true;
  if (remote.nikiLoved && !local.nikiLoved) m.nikiLoved = true;
  // Preserve declines from either side
  if (remote.nixed && !local.nixed) {
    m.nixed = true;
    m.nixedBy = remote.nixedBy;
    m.nixedAt = remote.nixedAt;
  }
  // Preserve notes — keep remote notes if local is empty
  if (remote.notes && !local.notes) m.notes = remote.notes;
  // Preserve cost edits — keep remote cost if local matches default
  const defaultProp = DEFAULT_PROPERTIES.find(d => d.id === local.id);
  if (defaultProp && local.cost === defaultProp.cost && remote.cost !== defaultProp.cost) {
    m.cost = remote.cost;
  }
  return m;
}

function mergeProperties(local, remote) {
  const remoteMap = new Map(remote.map(p => [p.id, p]));
  const localMap = new Map(local.map(p => [p.id, p]));
  const merged = [];

  // Merge properties that exist in local
  for (const lp of local) {
    if (remoteMap.has(lp.id)) {
      merged.push(mergeProperty(lp, remoteMap.get(lp.id)));
    } else {
      merged.push({...lp});
    }
  }

  // Add remote-only properties (added by the other person)
  for (const rp of remote) {
    if (!localMap.has(rp.id)) {
      merged.push({...rp});
    }
  }

  return merged;
}

// ==================== SYNC ====================
async function syncToRemote() {
  try {
    STATE.syncStatus = "syncing";
    render();

    // Fetch current remote state and merge before pushing
    let remote = [];
    try {
      const getRes = await fetch(STATE.apiUrl + "/api/properties");
      if (getRes.ok) {
        const data = await getRes.json();
        if (Array.isArray(data) && data.length) remote = data;
      }
    } catch(e) {}

    const toSave = remote.length ? mergeProperties(STATE.properties, remote) : STATE.properties;
    STATE.properties = toSave;
    saveStateLocal();

    const res = await fetch(STATE.apiUrl + "/api/properties", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(toSave)
    });
    STATE.syncStatus = res.ok ? "connected" : "error";
  } catch(e) {
    STATE.syncStatus = "error";
  }
  render();
}

async function syncFromRemote() {
  if (!STATE.apiUrl) return;
  try {
    const res = await fetch(STATE.apiUrl + "/api/properties");
    if (res.ok) {
      const data = await res.json();
      if (data && data.length) {
        migrateProperties(data);
        // Merge remote into local instead of overwriting
        STATE.properties = mergeProperties(STATE.properties, data);
        STATE.syncStatus = "connected";
        saveStateLocal();
        render();
      }
    }
  } catch(e) {
    STATE.syncStatus = "local";
  }
}

// ==================== ACTIONS ====================
function declineProperty(id, who) {
  const prop = STATE.properties.find(p => p.id === id);
  if (prop) {
    prop.nixed = true;
    prop.nixedBy = who;
    prop.nixedAt = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    saveState(); render(); renderMap();
  }
}

function restoreProperty(id) {
  const prop = STATE.properties.find(p => p.id === id);
  if (prop) { prop.nixed = false; prop.nixedBy = ''; prop.nixedAt = ''; saveState(); render(); renderMap(); }
}

function toggleLove(id, who) {
  const prop = STATE.properties.find(p => p.id === id);
  if (!prop) return;
  if (who === 'ferrell') prop.ferrellLoved = !prop.ferrellLoved;
  else prop.nikiLoved = !prop.nikiLoved;
  saveState(); render();
}

function updateCost(id, cost) {
  const prop = STATE.properties.find(p => p.id === id);
  if (prop) { prop.cost = cost; saveState(); }
}

function updateNotes(id, notes) {
  const prop = STATE.properties.find(p => p.id === id);
  if (prop) { prop.notes = notes; saveState(); }
}

function deleteProperty(id) {
  STATE.properties = STATE.properties.filter(p => p.id !== id);
  saveState(); render(); renderMap();
}

function addProperty() {
  const name = document.getElementById('add-name').value.trim();
  if (!name) return;
  const cost = document.getElementById('add-cost').value.trim() || '';
  const linkEl = document.getElementById('add-link');
  const link = linkEl ? linkEl.value.trim() : '';
  const notes = document.getElementById('add-notes').value.trim() || '';
  const id = 'custom-' + Date.now();
  STATE.properties.push({
    id, name, city: '', address: '', lat: 0, lng: 0,
    cost, costMin: 0, walkScore: 0,
    walkableTo: [], amenities: [],
    standout: '', distHeron: { miles: 0, mins: 0 }, distMiami: { miles: 0, mins: 0 },
    link, layoutLink: link, special: '', notes, nixed: false, nixedBy: '', nixedAt: '', ferrellLoved: false, nikiLoved: false
  });
  saveState();
  render();
  renderMap();
}

// ==================== RENDER ====================
function wsLabel(score) {
  if (score >= 90) return "Walker's Paradise";
  if (score >= 70) return 'Very Walkable';
  if (score >= 50) return 'Somewhat Walkable';
  return 'Car-Dependent';
}

function wsColor(score) {
  if (score >= 90) return '#16a34a';
  if (score >= 70) return '#65a30d';
  if (score >= 50) return '#ca8a04';
  return '#dc2626';
}

function driveRange(mins) {
  const lo = Math.max(5, mins - 5);
  const hi = mins + 5;
  return lo + '–' + hi + ' min';
}

function renderActionCell(p, who, lovedKey, isPassed) {
  if (isPassed) {
    const isThisDeclined = p.nixedBy === who;
    if (isThisDeclined) {
      return `<button class="btn-restore" onclick="restoreProperty('${p.id}')">Restore</button>
        <div class="declined-info">${p.nixedAt || ''}</div>`;
    }
    return '';
  }
  return `<span class="act-wrap"><button class="act-btn act-love ${p[lovedKey] ? 'loved' : ''}" onclick="toggleLove('${p.id}','${who}')" title="${p[lovedKey] ? 'Remove from favorites' : 'Favorite'}">&#9829;</button><span class="act-label">Love</span></span><span class="act-wrap"><button class="act-btn act-pass" onclick="declineProperty('${p.id}','${who}')" title="Decline">&times;</button><span class="act-label">Decline</span></span>`;
}

function renderPropertyRow(p, isPassed) {
  return `
    <tr>
      <td>
        ${p.link ? `<a class="prop-name" href="${p.link}" target="_blank">${p.name}</a>` : `<span class="prop-name" style="color:var(--text)">${p.name}</span>`}
        ${p.city ? `<div class="prop-sub">${p.city}</div>` : ''}
        ${p.layoutLink ? `<a class="floor-plans-link" href="${p.layoutLink}" target="_blank">Floor plans</a>` : ''}
        ${p.id.startsWith('custom-') ? `<button class="delete-btn" onclick="deleteProperty('${p.id}')">Delete</button>` : ''}
      </td>
      <td>
        <input class="cost-input" type="text" value="${p.cost}"
          onchange="updateCost('${p.id}', this.value)"
          onblur="updateCost('${p.id}', this.value)" />
        ${p.special ? `<div class="cost-special">${p.special}</div>` : ''}
      </td>
      <td>
        ${p.walkScore ? `
        <div class="ws">
          <span class="ws-num" style="color:${wsColor(p.walkScore)}">${p.walkScore}</span>
        </div>
        <div class="ws-label">${wsLabel(p.walkScore)}</div>
        ` : '<span style="color:var(--text-light)">—</span>'}
      </td>
      <td>
        <div class="nearby">${(p.walkableTo || []).join(', ')}</div>
      </td>
      <td>
        <div class="standout-text">${p.standout || ''}</div>
        <div class="amenities-list">${(p.amenities || []).join(', ')}</div>
      </td>
      <td>
        <div class="dist-stack">${p.distHeron && p.distHeron.mins ? driveRange(p.distHeron.mins) : '—'}</div>
      </td>
      <td>
        <div class="dist-stack">${p.distMiami && p.distMiami.mins ? driveRange(p.distMiami.mins) : '—'}</div>
      </td>
      <td class="notes-cell">
        <textarea class="note-textarea" placeholder="Add notes..."
          onchange="updateNotes('${p.id}', this.value)"
          onblur="updateNotes('${p.id}', this.value)"
        >${p.notes}</textarea>
      </td>
      <td class="actions-cell">${renderActionCell(p, 'ferrell', 'ferrellLoved', isPassed)}</td>
      <td class="actions-cell">${renderActionCell(p, 'niki', 'nikiLoved', isPassed)}</td>
    </tr>
  `;
}

function render() {
  const active = STATE.properties.filter(p => !p.nixed);
  const passed = STATE.properties.filter(p => p.nixed);
  const showing = STATE.activeTab === "active" ? active : passed;

  const syncDotClass = STATE.syncStatus === "connected" ? "connected" :
                       STATE.syncStatus === "error" ? "disconnected" : "local";
  const syncLabel = STATE.syncStatus === "connected" ? "Synced" :
                    STATE.syncStatus === "syncing" ? "Syncing..." :
                    STATE.syncStatus === "error" ? "Sync error" : "Local only";

  document.getElementById('app').innerHTML = `
    <div class="header">
      <div>
        <h1>Reset Home</h1>
      </div>
    </div>

    <div class="tab-bar">
      <div class="tab ${STATE.activeTab === 'active' ? 'active' : ''}"
           onclick="STATE.activeTab='active';render()">
        Active (${active.length})
      </div>
      <div class="tab ${STATE.activeTab === 'passed' ? 'active' : ''}"
           onclick="STATE.activeTab='passed';render()">
        Declined (${passed.length})
      </div>
    </div>

    <div class="content">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Community</th>
              <th>Cost (2BR/mo)</th>
              <th>Walk Score</th>
              <th>Location & Nearby</th>
              <th>Why It Stands Out</th>
              <th>Heron Bay</th>
              <th>Miami Beach</th>
              <th>Notes</th>
              <th>Ferrell</th>
              <th>Niki</th>
            </tr>
          </thead>
          <tbody>
            ${showing.length === 0
              ? `<tr><td colspan="10" class="empty-row">
                  ${STATE.activeTab === 'active' ? 'No active properties. Restore from the Declined tab.' : 'No declined properties.'}
                 </td></tr>`
              : showing.map(p => renderPropertyRow(p, STATE.activeTab === 'passed')).join('')
            }
            ${STATE.activeTab === 'active' ? `
            <tr class="add-section-header"><td colspan="10">Add to List</td></tr>
            <tr class="add-row">
              <td><input class="add-input" id="add-name" type="text" placeholder="Place name" onkeydown="if(event.key==='Enter')addProperty()" /></td>
              <td><input class="add-input" id="add-cost" type="text" placeholder="Price" onkeydown="if(event.key==='Enter')addProperty()" /></td>
              <td></td>
              <td><input class="add-input" id="add-link" type="text" placeholder="Link (URL)" onkeydown="if(event.key==='Enter')addProperty()" /></td>
              <td colspan="3"></td>
              <td><input class="add-input" id="add-notes" type="text" placeholder="Notes" onkeydown="if(event.key==='Enter')addProperty()" /></td>
              <td colspan="2"><button class="add-btn" onclick="addProperty()">+ Add</button></td>
            </tr>
            ` : ''}
          </tbody>
        </table>
      </div>

      <div class="map-section">
        <h2>Map</h2>
        <div id="map"></div>
      </div>
    </div>

    ${STATE.showConfig ? renderConfigModal() : ''}
  `;

  renderMap();
}

function renderConfigModal() {
  return `
    <div class="modal-overlay" onclick="if(event.target===this){STATE.showConfig=false;render()}">
      <div class="modal">
        <h2>Settings</h2>
        <p>Cloudflare Worker URL for syncing between devices.</p>
        <input id="configApiUrl" type="text" placeholder="https://apartment-finder.your-subdomain.workers.dev" value="${STATE.apiUrl}" />
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="STATE.showConfig=false;render()">Cancel</button>
          <button class="modal-btn modal-btn-save" onclick="STATE.apiUrl=document.getElementById('configApiUrl').value;STATE.showConfig=false;saveState();syncFromRemote();render()">Save</button>
        </div>
      </div>
    </div>
  `;
}

// ==================== MAP ====================
let map = null;
let markers = [];

function renderMap() {
  const mapEl = document.getElementById('map');
  if (!mapEl) return;

  if (map) { map.remove(); map = null; }
  markers = [];

  map = L.map('map', { scrollWheelZoom: true }).setView([26.18, -80.14], 11);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
    maxZoom: 19
  }).addTo(map);

  // Heron Bay marker
  const heronIcon = L.divIcon({
    html: '<div style="background:#6366f1;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.2)"></div>',
    iconSize: [12, 12],
    className: ''
  });
  L.marker([26.19, -80.26], { icon: heronIcon })
    .addTo(map)
    .bindPopup('<b>Heron Bay, Parkland</b><br>Home base');

  // Property markers
  const active = STATE.properties.filter(p => !p.nixed);
  active.forEach(p => {
    const color = '#2563eb';
    const icon = L.divIcon({
      html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.2)"></div>`,
      iconSize: [10, 10],
      className: ''
    });
    const marker = L.marker([p.lat, p.lng], { icon: icon })
      .addTo(map)
      .bindPopup(`
        <b>${p.name}</b><br>
        <span style="font-size:0.85rem">${p.city}</span><br>
        <span style="font-weight:600">${p.cost}</span><br>
        ~${p.distHeron.mins} min to Heron Bay<br>
        <a href="${p.link}" target="_blank">View property</a>
      `);
    markers.push(marker);
  });

  // Miami Beach marker
  const miamiIcon = L.divIcon({
    html: '<div style="background:#f59e0b;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.2)"></div>',
    iconSize: [12, 12],
    className: ''
  });
  L.marker([25.7907, -80.13], { icon: miamiIcon })
    .addTo(map)
    .bindPopup('<b>Miami Beach</b>');

  // Fit bounds
  const allPoints = [[26.19, -80.26], [25.7907, -80.13], ...active.map(p => [p.lat, p.lng])];
  if (allPoints.length > 1) {
    map.fitBounds(allPoints, { padding: [40, 40] });
  }
}

// ==================== INIT ====================
(async function init() {
  loadState();
  render(); // render immediately with localStorage data
  await syncFromRemote(); // then merge in remote data
  // Poll for remote changes every 30s
  setInterval(() => {
    if (STATE.apiUrl) syncFromRemote();
  }, 30000);
})();
</script>
</body>
</html>
